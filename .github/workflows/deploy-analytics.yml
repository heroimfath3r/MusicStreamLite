name: ğŸš€ Deploy Analytics Service

on:
  push:
    branches: 
      - main
    paths:
      - 'analytics-service/**'
      - '.github/workflows/deploy-analytics.yml'

env:
  PROJECT_ID: musicstreamlite
  SERVICE_NAME: analytics-service
  REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. Checkout code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2. Auth to GCP with Service Account Key
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      # 3. Setup gcloud CLI
      - name: ğŸ”§ Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'
      
      # 4. Configure Docker for Google Artifact Registry
      - name: ğŸ³ Configure Docker for GAR
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}
      
      # 5. Build Docker image
      - name: ğŸ—ï¸ Build Docker image
        working-directory: ./analytics-service
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:latest \
            .
      
      # 6. Push to Google Artifact Registry
      - name: ğŸ“¤ Push to Google Artifact Registry
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:latest
      
      # 7. Deploy to Cloud Run
      - name: ğŸš€ Deploy to Google Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=512Mi \
            --timeout=300s \
            --set-env-vars="FIRESTORE_PROJECT_ID=${{ env.PROJECT_ID }},NODE_ENV=production" \
            --project=${{ env.PROJECT_ID }}
      
      # 8. Get service URL
      - name: ğŸ“ Get service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)' \
            --project=${{ env.PROJECT_ID }})
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ğŸ”— Service URL: $URL"
      
      # 9. Health check
      - name: âœ… Health check
        run: |
          sleep 10
          SERVICE_URL="${{ steps.service-url.outputs.url }}"
          echo "Checking health at: $SERVICE_URL/api/analytics/health"
          curl -f "$SERVICE_URL/api/analytics/health" || exit 1
      
      # 10. Success notification
      - name: ğŸ‰ Deployment successful
        run: |
          echo "âœ… Analytics Service deployed successfully"
          echo "ğŸ“ Region: ${{ env.REGION }}"
          echo "ğŸ”— URL: ${{ steps.service-url.outputs.url }}"
          echo "ğŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:${{ github.sha }}"